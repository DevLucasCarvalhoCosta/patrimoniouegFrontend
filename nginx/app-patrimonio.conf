# ============================================
# API e Uploads do Patrim√¥nio
# ============================================

# Uploads (Imagens)
location /uploads/ {
    proxy_pass http://patrimonio-backend:3000/uploads/;
    include /etc/nginx/includes/proxy-params.conf;

    # CORS para imagens
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;

    # Cache para uploads (imagens)
    expires 1y;
    add_header Cache-Control "public, immutable";

    # Timeouts
    proxy_read_timeout 30s;
    proxy_connect_timeout 10s;
}

# API Backend
location /api/ {
    proxy_pass http://patrimonio-backend:3000/api/;
    include /etc/nginx/includes/proxy-params.conf;

    # CORS Headers
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;

    # Preflight requests
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
        add_header 'Access-Control-Max-Age' 86400 always;
        add_header 'Content-Type' 'text/plain; charset=utf-8' always;
        add_header 'Content-Length' 0 always;
        return 204;
    }

    # Timeouts maiores para API
    proxy_read_timeout 60s;
    proxy_connect_timeout 10s;
}

# Portal de Dados Abertos - CKAN
location /ckan/ {
    proxy_pass https://dadosabertos.go.gov.br/;
    proxy_ssl_server_name on;
    proxy_ssl_protocols TLSv1.2 TLSv1.3;

    # Headers para proxy
    proxy_set_header Host dadosabertos.go.gov.br;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # CORS Headers
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range' always;

    # Preflight
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
        add_header 'Access-Control-Max-Age' 86400 always;
        add_header 'Content-Length' 0 always;
        return 204;
    }

    # Timeouts
    proxy_read_timeout 30s;
    proxy_connect_timeout 10s;

    # Remover o prefixo /ckan/ ao fazer proxy
    rewrite ^/ckan/(.*) /$1 break;
}
